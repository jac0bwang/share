# CPU 的上下文切换

CPU 的上下文切换就可以分为几个不同的场景，就是进程上下文切换、线程上下文切换以及中断上下文切换

## 进程上下文切换

一次系统调用的过程，其实是发生了两次 CPU 上下文切换。

CPU 寄存器里原来用户态的指令位置，需要先保存起来。接着，为了执行内核态代码，CPU 寄存器需要更新为内核态指令的新位置。最后才是跳转到内核态运行内核任务。
而系统调用结束后，CPU寄存器需要恢复原来保存的用户态，然后再切换到用户空间，继续运行进程。

进程的上下文不仅包括了虚拟内存、栈、全局变量等用户空间的资源，还包括了内核堆栈、寄存器等内核空间的状态。

只有在进程调度的时候，才需要切换上下文

进程在什么时候才会被调度到 CPU 上运行呢？

1. 进程执行完终止
2. 进程的时间片耗尽了，就会被系统挂起，切换到其它正在等待 CPU 的进程运行
3. 进程在系统资源不足（比如内存不足）时，要等到资源满足后才可以运行
4. 当进程通过睡眠函数 sleep 这样的方法将自己主动挂起
5. 当有优先级更高的进程运行时，为了保证高优先级进程的运行
6. 发生硬件中断时，CPU上的进程会被中断挂起，转而执行内核中的中断服务程序

## 线程上下文切换

线程是调度的基本单位，而进程则是资源拥有的基本单位

- 当进程只有一个线程时，可以认为进程就等于线程。
- 当进程拥有多个线程时，这些线程会共享相同的虚拟内存和全局变量等资源。这些资源在上下文切换时是不需要修改的。
- 线程也有自己的私有数据，比如栈和寄存器等，这些在上下文切换时也是需要保存的。

## 中断上下文切换

中断上下文，其实只包括内核态中断服务程序执行所必需的状态，包括CPU 寄存器、内核堆栈、硬件中断参数
